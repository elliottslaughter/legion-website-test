<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Multiple Partitions &#8211; Legion Programming System</title>
<meta name="description" content="">

<meta name="keywords" content="">


<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Multiple Partitions">
<meta property="og:description" content="Home page for the Legion parallel programming system">
<meta property="og:url" content="/legion-website-test/tutorial/multiple.html">
<meta property="og:site_name" content="Legion Programming System">





<link rel="canonical" href="/legion-website-test/tutorial/multiple.html">
<link href="/legion-website-test/feed.xml" type="application/atom+xml" rel="alternate" title="Legion Programming System Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Webfonts -->
<link href='https://fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700|PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
<!-- For all browsers -->
<link rel="stylesheet" href="/legion-website-test/assets/css/main.min.css">

<!--[if (lt IE 9) & (!IEMobile)]>
<link rel="stylesheet" href="/legion-website-test/assets/css/ie.min.css">
<![endif]-->

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/legion-website-test/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<link rel="icon" sizes="16x16" href="/legion-website-test/images/favicon/favicon-16x16.png">
<link rel="icon" sizes="32x32" href="/legion-website-test/images/favicon/favicon-32x32.png">
<link rel="icon" sizes="48x48" href="/legion-website-test/images/favicon/favicon-48x48.png">
<link rel="icon" sizes="96x96" href="/legion-website-test/images/favicon/favicon-96x96.png">
<link rel="icon" sizes="144x144" href="/legion-website-test/images/favicon/favicon-144x144.png">
<link rel="icon" sizes="192x192" href="/legion-website-test/images/favicon/favicon-192x192.png">
<link rel="apple-touch-icon" sizes="57x57" href="/legion-website-test/images/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/legion-website-test/images/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/legion-website-test/images/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/legion-website-test/images/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/legion-website-test/images/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/legion-website-test/images/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/legion-website-test/images/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/legion-website-test/images/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/legion-website-test/images/favicon/apple-icon-180x180.png">
<link rel="apple-touch-icon-precomposed" sizes="192x192" href="/legion-website-test/images/favicon/apple-icon-precomposed.png">
<meta name="msapplication-config" content="/legion-website-test/images/favicon/browserconfig.xml" />
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
<link rel="manifest" href="/legion-website-test/images/favicon/manifest.json">

</head>

<body class="page" itemscope itemtype="http://schema.org/WebPage">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="/legion-website-test/">Legion Programming System</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" itemscope itemtype="http://schema.org/SiteNavigationElement">
		    <ul>
		        
				<li><a href="/legion-website-test/overview/" >Overview</a></li>
		        
				<li><a href="/legion-website-test/starting/" >Getting Started</a></li>
		        
				<li><a href="/legion-website-test/tutorial/" >Tutorials</a></li>
		        
				<li><a href="/legion-website-test/events/" >Events</a></li>
		        
				<li><a href="/legion-website-test/documentation/" >Documentation</a></li>
		        
				<li><a href="/legion-website-test/publications/" >Publications</a></li>
		        
				<li><a href="/legion-website-test/resources/" >Resources</a></li>
		        
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->




<div id="main" role="main"  itemprop="mainContentOfPage">
  <div class="article-author-side">
    <a href="https://www.stanford.edu/"><img src="/legion-website-test/images/logos/stanford.png" class="bio-photo" alt="Stanford University logo"></a>
<a href="https://www6.slac.stanford.edu/"><img src="/legion-website-test/images/logos/slac.jpg" class="bio-photo" alt="SLAC National Accelerator Laboratory logo"></a>
<a href="https://www.lanl.gov/"><img src="/legion-website-test/images/logos/los-alamos.png" class="bio-photo" alt="Los Alamos National Laboratory logo"></a>
<a href="https://www.nvidia.com/"><img src="/legion-website-test/images/logos/nvidia.png" class="bio-photo" alt="NVIDIA logo"></a>
<a href="https://www.rdworldonline.com/rd-100-award-winners-announced-in-analytical-test-it-electrical-categories/"><img src="/legion-website-test/images/logos/rd100.png" class="bio-photo" alt="Winner of the R&D 100 Award"></a>

<h3>Legion</h3>
<p>High Productivity High Performance Computing</p>





<a href="http://github.com/StanfordLegion/legion" class="author-social" target="_blank"><i class="icon-github"></i> Github</a>



  </div>
  <article itemscope itemtype="http://schema.org/CreativeWork">
    <h1 itemprop="name">Multiple Partitions</h1>
    <div class="article-wrap" itemprop="text">
      <p>We deviate from our running DAXPY application
in this example to illustrate how Legion permits
applications to create multiple logical partitions
of the same logical region, thereby enabling multiple
views onto the same set of data. To do this, we’ll
construct a simple program to compute the derivative
of some data by performing a simple 1-D 5-point stencil
on a discretized space using the standard formula.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>f'(x) = (-f(x+2) + 8f(x+1) - 8f(x-1) + f(x-2))/12
</code></pre></div></div>

<p>To perform the stencil computation we create the
<code class="language-plaintext highlighter-rouge">stencil_lr</code> logical region with two fields: one
field containing the input values and a second field
to store the computed derivative value at each point
(lines 37-46). After creating the logical regions
we partition the <code class="language-plaintext highlighter-rouge">stencil_lr</code> logical region in
two different ways which we cover in the next
section. After partitioning the logical region
we initialize the data in our value field using
the <code class="language-plaintext highlighter-rouge">init_field_task</code> (lines 67-73, identical
to the one from our DAXPY example). We then launch
an index space of tasks to perform the stencil
computation in parallel (lines 75-85). Finally,
a single task is launched to check the result of
the stencil computation (lines 87-95).</p>

<h4 id="creating-and-using-multiple-partitions">Creating and Using Multiple Partitions</h4>

<p>To be able to compute the stencil computation in
parallel, we need to create two partitions: one
disjoint partition with each logical sub-region
describing the points that each tasks will write,
and a second partition with each logical sub-region
describing the points that each task will need to
read from to perform the stencil computation.
While the first partition will be disjoint, the
second partition will be <em>aliased</em> because each
sub-region will additionally require two <em>ghost</em> cells on
each side of the set of elements in
each sub-region in the disjoint partition.
The need for these ghost cells means that some
cells will exist in multiple sub-regions and
therefore sub-regions of the partition may overlap.</p>

<p>We create the disjoint partition with <code class="language-plaintext highlighter-rouge">create_equal_partition</code> as we
did the previous example (lines 51-52). For the new, aliased partition
we use another runtime method called <code class="language-plaintext highlighter-rouge">create_partition_by_restriction</code>
(lines 53-58). This method works by multiplying every index point in
the color space of the partition by a transform matrix, to determine
the offset of the subregion to create. This essentially allows us to
create a bunch of overlapping subregions of the same size, with a
certain offset between them.</p>

<p>After we’ve computed the two index partitions we obtain the
corresponding logical partitions (lines 60-63). The following figure
shows the resulting logical region tree for the application.</p>

<p><img src="/legion-website-test/images/stencil_partition.svg" alt="" /></p>

<p>Legion’s support of multiple partitions for
logical regions enables applications to use
different views of the same data even within
the same task. Consider the index space task
launch for performing the stencil computation.
We pass two projection region requirements
in the launcher object. The first region
requirement requests <code class="language-plaintext highlighter-rouge">READ_ONLY</code> privileges
on the aliased <code class="language-plaintext highlighter-rouge">ghost_lp</code> logical partition
for the <code class="language-plaintext highlighter-rouge">FID_VAL</code> field (lines 77-80).
The second region requirement requests
<code class="language-plaintext highlighter-rouge">READ_WRITE</code> privileges on the <code class="language-plaintext highlighter-rouge">disjoint_lp</code>
logical partition for the <code class="language-plaintext highlighter-rouge">FID_DERIV</code> field
(lines 81-84). In the next section we describe
how Legion proves that all of the stencil
tasks can be run in parallel.</p>

<h4 id="privilege-non-interference">Privilege Non-Interference</h4>

<p>To prove that all of the stencil tasks can run
in parallel, the Legion runtime relies on all
three kinds of non-interference including one
we have not yet covered: privilege non-interference.
First, field non-interference ensures that any
point task’s first region requirement is disjoint
from any other point task’s second region requirement
as the two region requirements use different fields.
Next, logical region non-interference ensures all
tasks are non-interfering with respect to every other
task’s second region requirement because a disjoint
partition is used. The last case where non-interference
must be shown is with regards to the first region
requirement between any pair of tasks. Neither field-level
nor logical region non-interference applies. However,
since all tasks are only requesting <code class="language-plaintext highlighter-rouge">READ_ONLY</code>
privileges, then the tasks are non-interfering on
privileges because tasks that are only reading data cannot
interfere with each other. Consequently, all the
point tasks in the stencil index space launch
can be run in parallel.</p>

<p>Next Example: <a href="/legion-website-test/tutorial/custom_mappers.html">Custom Mappers</a><br />
Previous Example: <a href="/legion-website-test/tutorial/partitioning.html">Partitioning</a></p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
</pre></td><td class="code"><pre><span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cassert&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;cstdlib&gt;</span><span class="cp">
#include</span> <span class="cpf">"legion.h"</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">Legion</span><span class="p">;</span>

<span class="k">enum</span> <span class="n">TaskIDs</span> <span class="p">{</span>
  <span class="n">TOP_LEVEL_TASK_ID</span><span class="p">,</span>
  <span class="n">INIT_FIELD_TASK_ID</span><span class="p">,</span>
  <span class="n">STENCIL_TASK_ID</span><span class="p">,</span>
  <span class="n">CHECK_TASK_ID</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">FieldIDs</span> <span class="p">{</span>
  <span class="n">FID_VAL</span><span class="p">,</span>
  <span class="n">FID_DERIV</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">top_level_task</span><span class="p">(</span><span class="k">const</span> <span class="n">Task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PhysicalRegion</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">regions</span><span class="p">,</span>
                    <span class="n">Context</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">Runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">num_elements</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">num_subregions</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="p">{</span>
      <span class="k">const</span> <span class="n">InputArgs</span> <span class="o">&amp;</span><span class="n">command_args</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">::</span><span class="n">get_input_args</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">command_args</span><span class="p">.</span><span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">command_args</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s">"-n"</span><span class="p">))</span>
        <span class="n">num_elements</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">command_args</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">command_args</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s">"-b"</span><span class="p">))</span>
        <span class="n">num_subregions</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">command_args</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Running stencil computation for %d elements...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">num_elements</span><span class="p">);</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Partitioning data into %d sub-regions...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">num_subregions</span><span class="p">);</span>

  <span class="n">Rect</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">elem_rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">num_elements</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">IndexSpaceT</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">is</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">create_index_space</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">elem_rect</span><span class="p">);</span>
  <span class="n">FieldSpace</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">create_field_space</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
  <span class="p">{</span>
    <span class="n">FieldAllocator</span> <span class="n">allocator</span> <span class="o">=</span>
      <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">create_field_allocator</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">fs</span><span class="p">);</span>
    <span class="n">allocator</span><span class="p">.</span><span class="n">allocate_field</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">),</span><span class="n">FID_VAL</span><span class="p">);</span>
    <span class="n">allocator</span><span class="p">.</span><span class="n">allocate_field</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">),</span><span class="n">FID_DERIV</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">LogicalRegion</span> <span class="n">stencil_lr</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">create_logical_region</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">is</span><span class="p">,</span> <span class="n">fs</span><span class="p">);</span>

  <span class="n">Rect</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">color_bounds</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">num_subregions</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="n">IndexSpaceT</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">color_is</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">create_index_space</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">color_bounds</span><span class="p">);</span>

  <span class="n">IndexPartition</span> <span class="n">disjoint_ip</span> <span class="o">=</span>
    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">create_equal_partition</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">is</span><span class="p">,</span> <span class="n">color_is</span><span class="p">);</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">block_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_elements</span> <span class="o">+</span> <span class="n">num_subregions</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_subregions</span><span class="p">;</span>
  <span class="n">Transform</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">transform</span><span class="p">;</span>
  <span class="n">transform</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">block_size</span><span class="p">;</span>
  <span class="n">Rect</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">extent</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">block_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">IndexPartition</span> <span class="n">ghost_ip</span> <span class="o">=</span>
    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">create_partition_by_restriction</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">is</span><span class="p">,</span> <span class="n">color_is</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">extent</span><span class="p">);</span>

  <span class="n">LogicalPartition</span> <span class="n">disjoint_lp</span> <span class="o">=</span>
    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">get_logical_partition</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">stencil_lr</span><span class="p">,</span> <span class="n">disjoint_ip</span><span class="p">);</span>
  <span class="n">LogicalPartition</span> <span class="n">ghost_lp</span> <span class="o">=</span>
    <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">get_logical_partition</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">stencil_lr</span><span class="p">,</span> <span class="n">ghost_ip</span><span class="p">);</span>

  <span class="n">ArgumentMap</span> <span class="n">arg_map</span><span class="p">;</span>

  <span class="n">IndexLauncher</span> <span class="n">init_launcher</span><span class="p">(</span><span class="n">INIT_FIELD_TASK_ID</span><span class="p">,</span> <span class="n">color_is</span><span class="p">,</span>
                              <span class="n">TaskArgument</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">arg_map</span><span class="p">);</span>
  <span class="n">init_launcher</span><span class="p">.</span><span class="n">add_region_requirement</span><span class="p">(</span>
      <span class="n">RegionRequirement</span><span class="p">(</span><span class="n">disjoint_lp</span><span class="p">,</span> <span class="mi">0</span><span class="cm">/*projection ID*/</span><span class="p">,</span>
                        <span class="n">WRITE_DISCARD</span><span class="p">,</span> <span class="n">EXCLUSIVE</span><span class="p">,</span> <span class="n">stencil_lr</span><span class="p">));</span>
  <span class="n">init_launcher</span><span class="p">.</span><span class="n">add_field</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">FID_VAL</span><span class="p">);</span>
  <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">execute_index_space</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">init_launcher</span><span class="p">);</span>

  <span class="n">IndexLauncher</span> <span class="n">stencil_launcher</span><span class="p">(</span><span class="n">STENCIL_TASK_ID</span><span class="p">,</span> <span class="n">color_is</span><span class="p">,</span>
       <span class="n">TaskArgument</span><span class="p">(</span><span class="o">&amp;</span><span class="n">num_elements</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">num_elements</span><span class="p">)),</span> <span class="n">arg_map</span><span class="p">);</span>
  <span class="n">stencil_launcher</span><span class="p">.</span><span class="n">add_region_requirement</span><span class="p">(</span>
      <span class="n">RegionRequirement</span><span class="p">(</span><span class="n">ghost_lp</span><span class="p">,</span> <span class="mi">0</span><span class="cm">/*projection ID*/</span><span class="p">,</span>
                        <span class="n">READ_ONLY</span><span class="p">,</span> <span class="n">EXCLUSIVE</span><span class="p">,</span> <span class="n">stencil_lr</span><span class="p">));</span>
  <span class="n">stencil_launcher</span><span class="p">.</span><span class="n">add_field</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">FID_VAL</span><span class="p">);</span>
  <span class="n">stencil_launcher</span><span class="p">.</span><span class="n">add_region_requirement</span><span class="p">(</span>
      <span class="n">RegionRequirement</span><span class="p">(</span><span class="n">disjoint_lp</span><span class="p">,</span> <span class="mi">0</span><span class="cm">/*projection ID*/</span><span class="p">,</span>
                        <span class="n">READ_WRITE</span><span class="p">,</span> <span class="n">EXCLUSIVE</span><span class="p">,</span> <span class="n">stencil_lr</span><span class="p">));</span>
  <span class="n">stencil_launcher</span><span class="p">.</span><span class="n">add_field</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">FID_DERIV</span><span class="p">);</span>
  <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">execute_index_space</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">stencil_launcher</span><span class="p">);</span>

  <span class="n">TaskLauncher</span> <span class="n">check_launcher</span><span class="p">(</span><span class="n">CHECK_TASK_ID</span><span class="p">,</span>
      <span class="n">TaskArgument</span><span class="p">(</span><span class="o">&amp;</span><span class="n">num_elements</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">num_elements</span><span class="p">)));</span>
  <span class="n">check_launcher</span><span class="p">.</span><span class="n">add_region_requirement</span><span class="p">(</span>
      <span class="n">RegionRequirement</span><span class="p">(</span><span class="n">stencil_lr</span><span class="p">,</span> <span class="n">READ_ONLY</span><span class="p">,</span> <span class="n">EXCLUSIVE</span><span class="p">,</span> <span class="n">stencil_lr</span><span class="p">));</span>
  <span class="n">check_launcher</span><span class="p">.</span><span class="n">add_field</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">FID_VAL</span><span class="p">);</span>
  <span class="n">check_launcher</span><span class="p">.</span><span class="n">add_region_requirement</span><span class="p">(</span>
      <span class="n">RegionRequirement</span><span class="p">(</span><span class="n">stencil_lr</span><span class="p">,</span> <span class="n">READ_ONLY</span><span class="p">,</span> <span class="n">EXCLUSIVE</span><span class="p">,</span> <span class="n">stencil_lr</span><span class="p">));</span>
  <span class="n">check_launcher</span><span class="p">.</span><span class="n">add_field</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">FID_DERIV</span><span class="p">);</span>
  <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">execute_task</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">check_launcher</span><span class="p">);</span>

  <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">destroy_logical_region</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">stencil_lr</span><span class="p">);</span>
  <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">destroy_field_space</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">fs</span><span class="p">);</span>
  <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">destroy_index_space</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">is</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">init_field_task</span><span class="p">(</span><span class="k">const</span> <span class="n">Task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
                     <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PhysicalRegion</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">regions</span><span class="p">,</span>
                     <span class="n">Context</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">Runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">regions</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">privilege_fields</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>

  <span class="n">FieldID</span> <span class="n">fid</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">privilege_fields</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">point</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">index_point</span><span class="p">.</span><span class="n">point_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"Initializing field %d for block %d...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">point</span><span class="p">);</span>

  <span class="k">const</span> <span class="n">FieldAccessor</span><span class="o">&lt;</span><span class="n">WRITE_DISCARD</span><span class="p">,</span><span class="kt">double</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">acc</span><span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fid</span><span class="p">);</span>

  <span class="n">Rect</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">rect</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">get_index_space_domain</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span>
                  <span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">region</span><span class="p">.</span><span class="n">get_index_space</span><span class="p">());</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">PointInRectIterator</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">pir</span><span class="p">(</span><span class="n">rect</span><span class="p">);</span> <span class="n">pir</span><span class="p">();</span> <span class="n">pir</span><span class="o">++</span><span class="p">)</span>
    <span class="n">acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span><span class="p">]</span> <span class="o">=</span> <span class="n">drand48</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">stencil_task</span><span class="p">(</span><span class="k">const</span> <span class="n">Task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
                  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PhysicalRegion</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">regions</span><span class="p">,</span>
                  <span class="n">Context</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">Runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">regions</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">privilege_fields</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">privilege_fields</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">arglen</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">max_elements</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">const</span> <span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">);</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">point</span> <span class="o">=</span> <span class="n">task</span><span class="o">-&gt;</span><span class="n">index_point</span><span class="p">.</span><span class="n">point_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

  <span class="n">FieldID</span> <span class="n">read_fid</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">privilege_fields</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
  <span class="n">FieldID</span> <span class="n">write_fid</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">privilege_fields</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>

  <span class="k">const</span> <span class="n">FieldAccessor</span><span class="o">&lt;</span><span class="n">READ_ONLY</span><span class="p">,</span><span class="kt">double</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">read_acc</span><span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">read_fid</span><span class="p">);</span>
  <span class="k">const</span> <span class="n">FieldAccessor</span><span class="o">&lt;</span><span class="n">WRITE_DISCARD</span><span class="p">,</span><span class="kt">double</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">write_acc</span><span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">write_fid</span><span class="p">);</span>

  <span class="n">Rect</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">rect</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">get_index_space_domain</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span>
                  <span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">region</span><span class="p">.</span><span class="n">get_index_space</span><span class="p">());</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">rect</span><span class="p">.</span><span class="n">lo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rect</span><span class="p">.</span><span class="n">hi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_elements</span><span class="o">-</span><span class="mi">3</span><span class="p">)))</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Running slow stencil path for point %d...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">point</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">PointInRectIterator</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">pir</span><span class="p">(</span><span class="n">rect</span><span class="p">);</span> <span class="n">pir</span><span class="p">();</span> <span class="n">pir</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">double</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">pir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">read_acc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="k">else</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">read_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">pir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="n">read_acc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="k">else</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="n">read_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">pir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_elements</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">read_acc</span><span class="p">[</span><span class="n">max_elements</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">else</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">read_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">pir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_elements</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">read_acc</span><span class="p">[</span><span class="n">max_elements</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">else</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">read_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>

      <span class="kt">double</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">l2</span> <span class="o">+</span> <span class="mf">8.0</span><span class="o">*</span><span class="n">l1</span> <span class="o">-</span> <span class="mf">8.0</span><span class="o">*</span><span class="n">r1</span> <span class="o">+</span> <span class="n">r2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">;</span>
      <span class="n">write_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Running fast stencil path for point %d...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">point</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">PointInRectIterator</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">pir</span><span class="p">(</span><span class="n">rect</span><span class="p">);</span> <span class="n">pir</span><span class="p">();</span> <span class="n">pir</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">double</span> <span class="n">l2</span> <span class="o">=</span> <span class="n">read_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
      <span class="kt">double</span> <span class="n">l1</span> <span class="o">=</span> <span class="n">read_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
      <span class="kt">double</span> <span class="n">r1</span> <span class="o">=</span> <span class="n">read_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
      <span class="kt">double</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">read_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>

      <span class="kt">double</span> <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">l2</span> <span class="o">+</span> <span class="mf">8.0</span><span class="o">*</span><span class="n">l1</span> <span class="o">-</span> <span class="mf">8.0</span><span class="o">*</span><span class="n">r1</span> <span class="o">+</span> <span class="n">r2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">;</span>
      <span class="n">write_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">check_task</span><span class="p">(</span><span class="k">const</span> <span class="n">Task</span> <span class="o">*</span><span class="n">task</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PhysicalRegion</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">regions</span><span class="p">,</span>
                <span class="n">Context</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">Runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">regions</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">privilege_fields</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">privilege_fields</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">arglen</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">max_elements</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">const</span> <span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">);</span>

  <span class="n">FieldID</span> <span class="n">src_fid</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">privilege_fields</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
  <span class="n">FieldID</span> <span class="n">dst_fid</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">privilege_fields</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>

  <span class="k">const</span> <span class="n">FieldAccessor</span><span class="o">&lt;</span><span class="n">READ_ONLY</span><span class="p">,</span><span class="kt">double</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">src_acc</span><span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src_fid</span><span class="p">);</span>
  <span class="k">const</span> <span class="n">FieldAccessor</span><span class="o">&lt;</span><span class="n">READ_ONLY</span><span class="p">,</span><span class="kt">double</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">dst_acc</span><span class="p">(</span><span class="n">regions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dst_fid</span><span class="p">);</span>

  <span class="n">Rect</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">rect</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">get_index_space_domain</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span>
                  <span class="n">task</span><span class="o">-&gt;</span><span class="n">regions</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">region</span><span class="p">.</span><span class="n">get_index_space</span><span class="p">());</span>

  <span class="kt">bool</span> <span class="n">all_passed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">PointInRectIterator</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">pir</span><span class="p">(</span><span class="n">rect</span><span class="p">);</span> <span class="n">pir</span><span class="p">();</span> <span class="n">pir</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">l2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
      <span class="n">l2</span> <span class="o">=</span> <span class="n">src_acc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">else</span>
      <span class="n">l2</span> <span class="o">=</span> <span class="n">src_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">l1</span> <span class="o">=</span> <span class="n">src_acc</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">else</span>
      <span class="n">l1</span> <span class="o">=</span> <span class="n">src_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_elements</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
      <span class="n">r1</span> <span class="o">=</span> <span class="n">src_acc</span><span class="p">[</span><span class="n">max_elements</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">else</span>
      <span class="n">r1</span> <span class="o">=</span> <span class="n">src_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">max_elements</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span>
      <span class="n">r2</span> <span class="o">=</span> <span class="n">src_acc</span><span class="p">[</span><span class="n">max_elements</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">else</span>
      <span class="n">r2</span> <span class="o">=</span> <span class="n">src_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>

    <span class="kt">double</span> <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">l2</span> <span class="o">+</span> <span class="mf">8.0</span><span class="o">*</span><span class="n">l1</span> <span class="o">-</span> <span class="mf">8.0</span><span class="o">*</span><span class="n">r1</span> <span class="o">+</span> <span class="n">r2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">received</span> <span class="o">=</span> <span class="n">dst_acc</span><span class="p">[</span><span class="o">*</span><span class="n">pir</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">expected</span> <span class="o">!=</span> <span class="n">received</span><span class="p">)</span>
      <span class="n">all_passed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">all_passed</span><span class="p">)</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"SUCCESS!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"FAILURE!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Runtime</span><span class="o">::</span><span class="n">set_top_level_task_id</span><span class="p">(</span><span class="n">TOP_LEVEL_TASK_ID</span><span class="p">);</span>

  <span class="p">{</span>
    <span class="n">TaskVariantRegistrar</span> <span class="n">registrar</span><span class="p">(</span><span class="n">TOP_LEVEL_TASK_ID</span><span class="p">,</span> <span class="s">"top_level"</span><span class="p">);</span>
    <span class="n">registrar</span><span class="p">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">ProcessorConstraint</span><span class="p">(</span><span class="n">Processor</span><span class="o">::</span><span class="n">LOC_PROC</span><span class="p">));</span>
    <span class="n">Runtime</span><span class="o">::</span><span class="n">preregister_task_variant</span><span class="o">&lt;</span><span class="n">top_level_task</span><span class="o">&gt;</span><span class="p">(</span><span class="n">registrar</span><span class="p">,</span> <span class="s">"top_level"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="p">{</span>
    <span class="n">TaskVariantRegistrar</span> <span class="n">registrar</span><span class="p">(</span><span class="n">INIT_FIELD_TASK_ID</span><span class="p">,</span> <span class="s">"init_field"</span><span class="p">);</span>
    <span class="n">registrar</span><span class="p">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">ProcessorConstraint</span><span class="p">(</span><span class="n">Processor</span><span class="o">::</span><span class="n">LOC_PROC</span><span class="p">));</span>
    <span class="n">registrar</span><span class="p">.</span><span class="n">set_leaf</span><span class="p">();</span>
    <span class="n">Runtime</span><span class="o">::</span><span class="n">preregister_task_variant</span><span class="o">&lt;</span><span class="n">init_field_task</span><span class="o">&gt;</span><span class="p">(</span><span class="n">registrar</span><span class="p">,</span> <span class="s">"init_field"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="p">{</span>
    <span class="n">TaskVariantRegistrar</span> <span class="n">registrar</span><span class="p">(</span><span class="n">STENCIL_TASK_ID</span><span class="p">,</span> <span class="s">"stencil"</span><span class="p">);</span>
    <span class="n">registrar</span><span class="p">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">ProcessorConstraint</span><span class="p">(</span><span class="n">Processor</span><span class="o">::</span><span class="n">LOC_PROC</span><span class="p">));</span>
    <span class="n">registrar</span><span class="p">.</span><span class="n">set_leaf</span><span class="p">();</span>
    <span class="n">Runtime</span><span class="o">::</span><span class="n">preregister_task_variant</span><span class="o">&lt;</span><span class="n">stencil_task</span><span class="o">&gt;</span><span class="p">(</span><span class="n">registrar</span><span class="p">,</span> <span class="s">"stencil"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="p">{</span>
    <span class="n">TaskVariantRegistrar</span> <span class="n">registrar</span><span class="p">(</span><span class="n">CHECK_TASK_ID</span><span class="p">,</span> <span class="s">"check"</span><span class="p">);</span>
    <span class="n">registrar</span><span class="p">.</span><span class="n">add_constraint</span><span class="p">(</span><span class="n">ProcessorConstraint</span><span class="p">(</span><span class="n">Processor</span><span class="o">::</span><span class="n">LOC_PROC</span><span class="p">));</span>
    <span class="n">registrar</span><span class="p">.</span><span class="n">set_leaf</span><span class="p">();</span>
    <span class="n">Runtime</span><span class="o">::</span><span class="n">preregister_task_variant</span><span class="o">&lt;</span><span class="n">check_task</span><span class="o">&gt;</span><span class="p">(</span><span class="n">registrar</span><span class="p">,</span> <span class="s">"check"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">Runtime</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>


    </div><!-- /.article-wrap -->
  </article>
</div><!-- /#index -->

<div class="footer-wrap">
  <footer>
    <span>&copy; 2023 Legion. Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <a href="http://mademistakes.com/">Minimal Mistakes</a> theme.</span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/legion-website-test/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/legion-website-test/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-20524102-3']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

          

</body>
</html>
